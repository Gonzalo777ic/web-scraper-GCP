<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Precios Cloud-Native</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-img { width: 60px; height: 60px; object-fit: contain; border-radius: 4px; border: 1px solid #eee; background: #fff; }
        .table td { vertical-align: middle; font-size: 0.9rem; }
        .badge-store { font-size: 0.8rem; min-width: 80px; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">üìâ Monitor de Precios</h2>
                <small class="text-muted">Arquitectura de Microservicios en GKE</small>
            </div>
            <div class="d-flex gap-2">
                <button onclick="loadData()" class="btn btn-primary btn-sm">üîÑ Recargar Datos</button>
            </div>
        </div>

        <div class="row mb-4 g-3">
            <div class="col-md-3">
                <div class="card p-3 border-0 shadow-sm h-100">
                    <h6 class="text-muted mb-1">Total Productos</h6>
                    <h3 id="total-count" class="fw-bold mb-0">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 border-0 shadow-sm h-100">
                    <h6 class="text-muted mb-1">Tiendas Detectadas</h6>
                    <h3 id="store-count" class="fw-bold mb-0 text-info">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 border-0 shadow-sm h-100">
                    <h6 class="text-muted mb-1">Valor Promedio</h6>
                    <h3 id="avg-price" class="fw-bold mb-0 text-success">S/ 0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 border-0 shadow-sm h-100">
                    <h6 class="text-muted mb-1">Estado API</h6>
                    <h3 id="system-status" class="fw-bold mb-0 fs-5 text-warning">Conectando...</h3>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üì¶ Inventario Global</h5>
                
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm" onclick="changePage(-1)">‚óÄ Anterior</button>
                    <span class="btn btn-outline-secondary btn-sm disabled" id="page-indicator">Pag 1</span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="changePage(1)">Siguiente ‚ñ∂</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px;">Img</th>
                                <th>Producto</th>
                                <th>Tienda</th>
                                <th>Precio</th>
                                <th>ID</th>
                            </tr>
                        </thead>
                        <tbody id="price-table">
                            <tr><td colspan="5" class="text-center py-5">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white text-muted text-end">
                <small id="showing-info">Mostrando 0-0 de 0</small>
            </div>
        </div>
    </div>

    <script>
        // Variables Globales para Paginaci√≥n
        let allData = [];
        let currentPage = 1;
        const itemsPerPage = 20; // Mostrar solo 20 por p√°gina para evitar lag

        async function loadData() {
            try {
                document.getElementById('system-status').innerText = "Sincronizando...";
                
                const pricesRes = await fetch('/api/prices');
                const prices = await pricesRes.json();

                // Guardamos todo en la variable global
                allData = prices;
                
                // M√©tricas
                const stores = [...new Set(prices.map(p => p.store))];
                const totalSum = prices.reduce((sum, p) => sum + (p.price || 0), 0);
                const avg = prices.length ? (totalSum / prices.length).toFixed(0) : 0;

                document.getElementById('system-status').innerText = "En L√≠nea ‚úÖ";
                document.getElementById('system-status').className = "fw-bold mb-0 fs-5 text-success";
                document.getElementById('total-count').innerText = prices.length;
                document.getElementById('store-count').innerText = stores.length;
                document.getElementById('avg-price').innerText = "S/ " + avg;

                // Renderizar primera p√°gina
                currentPage = 1;
                renderTable();

            } catch (e) {
                console.error(e);
                document.getElementById('system-status').innerText = "Desconectado ‚ùå";
                document.getElementById('system-status').className = "fw-bold mb-0 fs-5 text-danger";
            }
        }

        function renderTable() {
            const tableBody = document.getElementById('price-table');
            tableBody.innerHTML = "";

            if (allData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">Base de datos vac√≠a. Ejecuta el Scraper.</td></tr>';
                return;
            }

            // L√≥gica de Paginaci√≥n (Slice)
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = allData.slice(start, end);

            pageItems.forEach(p => {
                const img = p.image_url && p.image_url.startsWith('http') ? p.image_url : 'https://placehold.co/60x60?text=No+Img';
                const store = p.store || 'Desconocido';
                // Color de badge seg√∫n tienda
                let badgeColor = 'bg-secondary';
                if(store.includes('Lenovo')) badgeColor = 'bg-primary';
                if(store.includes('HP')) badgeColor = 'bg-info';
                if(store.includes('Asus')) badgeColor = 'bg-dark';
                if(store.includes('Falabella')) badgeColor = 'bg-success';

                const row = `
                    <tr>
                        <td><img src="${img}" class="product-img" loading="lazy" onerror="this.src='https://placehold.co/60x60?text=Err'"></td>
                        <td>
                            <div class="fw-bold" style="font-size: 0.95rem;">${p.name || "Sin Nombre"}</div>
                            <small class="text-muted" style="font-size: 0.75rem;">${p.timestamp}</small>
                        </td>
                        <td><span class="badge ${badgeColor} badge-store">${store}</span></td>
                        <td class="text-success fw-bold">S/ ${p.price}</td>
                        <td><small class="text-muted font-monospace">${p.product_id}</small></td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Actualizar indicadores
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            document.getElementById('page-indicator').innerText = `Pag ${currentPage} / ${totalPages}`;
            document.getElementById('showing-info').innerText = `Mostrando ${start + 1}-${Math.min(end, allData.length)} de ${allData.length}`;
        }

        function changePage(delta) {
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        loadData();
    </script>
</body>
</html>
